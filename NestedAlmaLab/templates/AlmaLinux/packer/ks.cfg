# AlmaLinux Kickstart for Packer Template Building
# Optimized for creating reusable VM templates

# Installation method and interface
text
install
cdrom

# Regional settings
lang en_US.UTF-8
keyboard us
timezone UTC

# Network configuration
network --bootproto=dhcp --device=eth0 --onboot=yes --activate
network --hostname=almalinux-template

# Authentication and security
rootpw --plaintext alma123!
auth --useshadow --passalgo=sha512
firewall --enabled --ssh --service=http --service=https
selinux --enforcing

# Boot loader configuration
bootloader --append="console=tty0 console=ttyS0,115200n8 net.ifnames=0"

# Disk partitioning - optimized for template
zerombr
clearpart --all --initlabel
# Use autopart for template - will be properly configured for each deployment
autopart --type=lvm

# Package selection - minimal but functional for template
%packages --ignoremissing --excludedocs
@core
@base
openssh-server
vim-enhanced
wget
curl
net-tools
bind-utils
python3
python3-pip
sudo
# Remove unnecessary packages to keep template smaller
-plymouth*
-fprintd-pam
-intltool
-NetworkManager-adsl
-NetworkManager-bluetooth
-NetworkManager-mobile
-NetworkManager-ppp
-NetworkManager-team
-NetworkManager-wifi
-NetworkManager-wwan
%end

# Pre-installation script
%pre --log=/var/log/ks-pre.log
echo "Starting AlmaLinux Packer template build at $(date)" >> /var/log/ks-pre.log
echo "This system will be prepared as a template for lab VMs" >> /var/log/ks-pre.log
%end

# Post-installation script - template preparation
%post --log=/var/log/ks-post.log

# Enable SSH service
systemctl enable sshd

# Configure SSH for lab access (template will inherit these settings)
sed -i 's/#PermitRootLogin yes/PermitRootLogin yes/' /etc/ssh/sshd_config
sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
sed -i 's/#PubkeyAuthentication yes/PubkeyAuthentication yes/' /etc/ssh/sshd_config

# Install EPEL repository
dnf install -y epel-release

# Create lab user (will be available in all VMs created from template)
useradd -m -s /bin/bash labuser
echo "labuser:labpass123!" | chpasswd
usermod -aG wheel labuser

# Configure sudo for lab user
echo "labuser ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/labuser
chmod 440 /etc/sudoers.d/labuser

# Configure basic firewall rules for lab
firewall-cmd --permanent --add-service=ssh
firewall-cmd --permanent --add-service=http
firewall-cmd --permanent --add-service=https
firewall-cmd --reload

# Configure network interface names consistently
echo 'GRUB_CMDLINE_LINUX="console=tty0 console=ttyS0,115200n8 net.ifnames=0"' >> /etc/default/grub
grub2-mkconfig -o /boot/grub2/grub.cfg

# Enable chronyd for time synchronization
systemctl enable chronyd

# Create basic template marker
echo "AlmaLinux VM Template" > /etc/hostname
echo "Built with Packer on $(date)" > /etc/template-info

# Template preparation - clean up for deployment
echo "Preparing template for deployment..."

# Clear any temporary SSH keys (will be regenerated on first boot)
rm -f /etc/ssh/ssh_host_*

# Clear logs to start fresh in deployed VMs
> /var/log/messages
> /var/log/secure
> /var/log/maillog
> /var/log/cron
> /var/log/boot.log

# Clear bash history
> /root/.bash_history
> /home/labuser/.bash_history

# Clear temporary files
rm -rf /tmp/*
rm -rf /var/tmp/*

# Clear DNF cache to reduce template size
dnf clean all

# Clear machine-id so each VM gets unique ID
> /etc/machine-id

# Create template completion marker
touch /etc/packer-template-build
echo "Template build completed at $(date)" >> /var/log/ks-post.log
echo "Template ready for VM deployment" >> /var/log/ks-post.log

%end

# Reboot after installation
reboot
