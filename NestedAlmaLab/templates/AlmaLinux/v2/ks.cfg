# AlmaLinux Kickstart (enhanced headless VM) - Version 2
# Automated installation for nested virtualization lab with additional tools

# Installation method and interface
text
install
cdrom

# Regional settings
lang en_US.UTF-8
keyboard us
timezone UTC

# Network configuration
network --bootproto=dhcp --device=eth0 --onboot=yes --activate
network --hostname=almavm-auto

# Authentication and security
rootpw --plaintext alma123!
auth --useshadow --passalgo=sha512
firewall --enabled --ssh --service=http --service=https
selinux --enforcing

# Boot loader configuration
# Auto-detect UEFI vs BIOS and configure appropriately
bootloader --append="console=tty0 console=ttyS0,115200n8 net.ifnames=0"

# Disk partitioning
zerombr
clearpart --all --initlabel
# Use autopart with appropriate partitioning scheme
# This will automatically create UEFI or BIOS boot partitions as needed
autopart --type=lvm

# Package selection
%packages --ignoremissing --excludedocs
@core
@base
@development
openssh-server
vim-enhanced
wget
curl
git
tmux
htop
net-tools
bind-utils
tcpdump
nmap-ncat
python3
python3-pip
-plymouth*
-fprintd-pam
-intltool
%end

# Pre-installation script
%pre --log=/var/log/ks-pre.log
echo "Starting AlmaLinux v2 kickstart installation at $(date)" >> /var/log/ks-pre.log
%end

# Post-installation script
%post --log=/var/log/ks-post.log
# Enable SSH service
systemctl enable sshd

# Configure SSH for lab access
sed -i 's/#PermitRootLogin yes/PermitRootLogin yes/' /etc/ssh/sshd_config
sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config

# Install EPEL repository
dnf install -y epel-release

# Update system
dnf update -y

# Create a lab user
useradd -m -s /bin/bash labuser
echo "labuser:labpass123!" | chpasswd
usermod -aG wheel labuser

# Configure sudo for lab user
echo "labuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers.d/labuser

# Create enhanced welcome message
cat << 'EOF' > /etc/motd
===============================================
AlmaLinux VM ready - Nested Virtualization Lab
===============================================
Version: v2 (Enhanced)
Root password: alma123!
Lab user: labuser / labpass123!
SSH enabled on all interfaces

Installed tools:
- Development tools
- Python3 with pip
- Network utilities
- Git, tmux, htop
===============================================
EOF

# Configure network interface names
echo 'GRUB_CMDLINE_LINUX="console=tty0 console=ttyS0,115200n8 net.ifnames=0"' >> /etc/default/grub
grub2-mkconfig -o /boot/grub2/grub.cfg

# Configure basic firewall rules for lab
firewall-cmd --permanent --add-service=ssh
firewall-cmd --permanent --add-service=http
firewall-cmd --permanent --add-service=https
firewall-cmd --reload

# Set up basic monitoring
echo '*/5 * * * * root /usr/bin/uptime >> /var/log/uptime.log' > /etc/cron.d/monitoring

# Log completion
echo "Kickstart post-installation completed at $(date)" >> /var/log/ks-post.log
echo "System ready for lab use" >> /var/log/ks-post.log
%end

# Reboot after installation
reboot

